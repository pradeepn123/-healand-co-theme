<script>
  function changePageURL(){
    if(window.location.pathname != '/collections/all'){
      window.location = '/collections/all';
    }
  }
</script>

{%- liquid
  assign options = section.settings
  assign color_scheme = options.color_scheme
  assign img_ratio = options.img_ratio
  assign upsell_product_items = nil
-%}

{%- capture upsell_product_items -%}
  {%- if cart != empty -%}
    {%- for item in cart.items limit: 8 -%}
{% comment %} Wholesale_Club_Item_Prices Start {% endcomment %}
{% if item.product %}{% assign base_product = item.product %}{% else %}{% assign base_product = item %}{% endif %}
{% if item.variant %}{% assign base_variant = item.variant %}{% else %}{% assign base_variant = item.selected_or_first_available_variant %}{% endif %}

{% if shop.metafields.sawholesale['base_price'] == blank %}
  {% assign base_price = 'compare_at_price' %}
{% else %}
  {% assign base_price = shop.metafields.sawholesale['base_price'] %}
{% endif %}

{% assign saw_discount = 0 %}{% assign saw_has_discount = false %}

{% if customer.tags != blank %}
  {% for mf in base_product.metafields.sawholesale %}
    {% capture product_customer_tag %}{{ mf | first | replace: 'discount_', '' }}{% endcapture %}
    {% if customer.tags contains product_customer_tag %}
      {% assign saw_has_discount = true %}
      {% assign discount_key = product_customer_tag | prepend: 'discount_' %}
      {% assign price_key = product_customer_tag | prepend: 'price_' %}
      {% assign saw_discount = base_product.metafields.sawholesale[discount_key] | divided_by: 100.0 %}
    {% endif %}
  {% endfor %}
{% endif %}

{% assign saw_discount = 1 | minus: saw_discount %}

{% if base_price == 'price' or base_variant.compare_at_price == blank  or base_variant.compare_at_price == 0 or base_variant.compare_at_price < base_variant.price %}
  {% assign saw_variant_compare_at_price = base_variant.price %}
{% else %}
  {% assign saw_variant_compare_at_price = base_variant.compare_at_price %}
{% endif %}

{% assign cpe = shop.metafields.sawholesale['cpe'] | default: "true" %}
{% if base_variant.metafields.sawholesale[price_key] != blank and cpe == "true" %}
  {% assign saw_variant_price = base_variant.metafields.sawholesale[price_key] %}
{% else %}
  {% assign saw_variant_price = saw_variant_compare_at_price | times: saw_discount %}
{% endif %}

{% if saw_has_discount == false or saw_variant_price >= saw_variant_compare_at_price %}
  {% assign WCItem_OriginalPrice = item.original_price %}
  {% assign WCItem_FinalPrice = item.final_price %}
  {% assign WCItem_Price = item.price %}
  {% assign WCItem_PriceMin = item.price_min %}
  {% assign WCItem_PriceMax = item.price_max %}
  {% assign WCItem_CompareAtPrice = item.compare_at_price %}
  {% assign WCItem_CompareAtPriceMin = item.compare_at_price_min %}
  {% assign WCItem_CompareAtPriceMax = item.compare_at_price_max %}
  {% assign WCItem_OriginalLinePrice = item.original_line_price %}
  {% assign WCItem_FinalLinePrice = item.final_line_price %}
  {% assign WCItem_LinePrice = item.line_price %}
{% else %}
  {% assign WCItem_OriginalPrice = saw_variant_compare_at_price %}
  {% assign WCItem_FinalPrice = saw_variant_price %}
  {% assign WCItem_Price = saw_variant_price %}
  {% assign WCItem_PriceMin = item.price_min | times: saw_discount %}
  {% assign WCItem_PriceMax = item.price_max | times: saw_discount %}
  {% assign WCItem_CompareAtPrice = saw_variant_compare_at_price %}
  {% if base_product.compare_at_price_min != 0 %}{% assign WCItem_CompareAtPriceMin = base_product.compare_at_price_min %}{% else %}{% assign WCItem_CompareAtPriceMin = base_product.price_min %}{% endif %}
  {% if base_product.compare_at_price_max != 0 %}{% assign WCItem_CompareAtPriceMax = base_product.compare_at_price_max %}{% else %}{% assign WCItem_CompareAtPriceMax = base_product.price_max %}{% endif %}
  {% assign WCItem_OriginalLinePrice = WCItem_OriginalPrice | round | times: item.quantity %}
  {% assign WCItem_FinalLinePrice = WCItem_FinalPrice | round | times: item.quantity %}
  {% assign WCItem_LinePrice = WCItem_Price | round | times: item.quantity %}
{% endif %}
{% comment %} Wholesale_Club_Item_Prices End {% endcomment %}

      {%- liquid
        assign upsell_products = item.product.metafields.custom.upsell_products.value
      -%}
      {%- for product_handle in upsell_products -%}
          {% render 'cart-product-card',                      
            product: product_handle,
            addtocartbutton: section.settings.show_add_to_cart,
            img_ratio: img_ratio,
            show_mobile_carousel: true,
            product_available: product_handle.available,
            product_card_align: "left" %}
      {%- endfor -%}
    {%- endfor -%}
  {%- endif -%}
{%- endcapture -%}

{{ 'cart-drawer.css' | asset_url | stylesheet_tag: preload: true }}

{%- if settings.cart_type == 'drawer_and_page' or settings.cart_type == 'drawer_only' -%}
  {%- unless template.name contains 'cart' -%}
    <sidebar-cart
      class='sidebar-cart color-{{ color_scheme }}'
      id='sidebar-component-for-cart'
      data-with-overlay
      data-with-close-on-outside
      data-with-close-on-escape
      data-overlay-important
      data-sidebar-section
      data-section-id='{{ section.id }}'
      data-open-direction='right'
      tabindex='-1'
      {% if cart == empty %}
        is-empty
      {% endif %}
    >
      <template id='CartInSidebar'>
        <div class='sidebar-cart__body' data-sidebar-content>
          <div class='sidebar-cart__header-wrap' data-sidebar-cart-header>
            <div class='sidebar-cart__header'>
              <div class='sidebar-cart__header-title'>
                {{ 'general.sidebar_cart.title' | t }}
                &nbsp;
                {%- if cart.item_count > 0 -%}
                  <span class='sidebar-cart__header-product-count'>
                    {{- 'general.sidebar_cart.title_count' | t: count: cart.item_count -}}
                  </span>
                {%- endif -%}
              </div>

              <sidebar-button>
                <button
                  data-sidebar-button
                  data-sidebar-id='sidebar-component-for-cart'
                  class='unstyled-button sidebar-cart__close-button-wrapper close-button-with-scale-hover-wrapper'
                  tabindex='0'
                  aria-label='Close'
                >
                  <span class='close-button-with-scale-hover sidebar-cart__close-button'></span>
                </button>
              </sidebar-button>
            </div>
          </div>
          <div class='sidebar-cart__content' data-sidebar-cart-viewport>
            <div class='sidebar-cart__content-results' data-sidebar-cart-results>
              <div class='sidebar-cart__warning' data-sidebar-cart-warning>
                <h1 class='sidebar-cart__warning-title h6'>{{ 'general.empty_cart_page.title' | t }}</h1>
              </div>
              {%- if settings.cart_free_shipping_bar_visible -%}
                <div class='sidebar-cart__cart-free-shipping-bar' data-sidebar-cart-free-shipping-bar>
                  {% unless customer and customer.tags contains 'WS_Wholesale'%}
                    {% render 'cart-free-shipping-bar', inside_sidebar: true %}
                  {% endunless %}
                </div>
              {%- endif -%}
              <div class='sidebar-cart__cart-items' data-sidebar-cart-items>
                {%- render 'cart-items', inside_sidebar: true, section: section, img_ratio: img_ratio -%}
              </div>
            </div>            
          </div>
          <div class='sidebar-cart__footer' data-sidebar-cart-footer>
            {% if upsell_product_items != blank %}
              <div class="upsell_product_footer_main_info" data-sidebar-cart-items>
                <h4 class="h5">{{ section.settings.upsell_title }}</h4>
                <div class="upsell_product_footer">
                  {{ upsell_product_items }}
                </div>
              </div>
            {% endif %}
            <div class='sidebar-cart__subtotal-wrapper' {%- if upsell_product_items != blank -%} style="border-top: 1px solid #E7E7E7; padding-top: 12px;" {%- endif -%}>
              <notification-component class='notification sidebar-cart__notification' id='SidebarCartNotification'>
                <div class='notification__overlay'></div>
                <div class='notification__body'>
                  <div
                    class='alert notification__alert'
                    role='alert'
                    data-notification-alert
                  >
                    {%- render 'icon', icon_name: 'error', class: 'alert__icon' -%}
                    <div class='alert__text' data-notification-alert-text></div>
                    <div class='alert__close-icon-wrapper' data-notification-close-button>
                      {%- render 'icon', icon_name: 'notification-close', class: 'alert__close-icon' -%}
                    </div>
                  </div>
                </div>
              </notification-component>
              {%- render 'subtotal', inside_sidebar: true -%}
            </div>
            <sidebar-button class='sidebar-cart__warning-button-wrapper'>
              <button
                data-sidebar-button
                data-sidebar-id='sidebar-component-for-cart'
                class='btn btn--lg btn--solid sidebar-cart__warning-button'
                aria-label='{{ 'general.sidebar_cart.continue_shopping' | t }}'
                onclick = 'changePageURL()'
              >
                {{ 'general.sidebar_cart.continue_shopping' | t }}
              </button>
            </sidebar-button>
          </div>
        </div>
      </template>
    </sidebar-cart>
  {%- endunless -%}
{%- endif -%}

{% schema %}
{
  "name": "t:sections.cart_drawer.name",
  "tag": "aside",
  "settings": [
    {
      "type": "paragraph",
      "content": "Make the drawer section active or inactive in Theme settings > Cart"
    },
    {
      "type": "select",
      "id": "color_scheme",
      "options": [
        {
          "value": "default",
          "label": "t:sections.general_section_settings.color_scheme_option_default_label"
        },
        {
          "value": "primary",
          "label": "t:sections.general_section_settings.color_scheme_option_primary_label"
        },
        {
          "value": "secondary",
          "label": "t:sections.general_section_settings.color_scheme_option_secondary_label"
        },
        {
          "value": "custom-1",
          "label": "t:sections.general_section_settings.color_scheme_option_custom_1_label"
        },
        {
          "value": "custom-2",
          "label": "t:sections.general_section_settings.color_scheme_option_custom_2_label"
        },
        {
          "value": "custom-3",
          "label": "t:sections.general_section_settings.color_scheme_option_custom_3_label"
        }
      ],
      "default": "default",
      "label": "t:sections.general_section_settings.color_scheme_label",
      "info": "t:sections.general_section_settings.color_scheme_tip"
    },
    {
      "type": "select",
      "id": "img_ratio",
      "options": [
        {
          "value": "default",
          "label": "t:sections.general_section_settings.img_ratio_option_default_label"
        },
        {
          "value": "square",
          "label": "t:sections.general_section_settings.img_ratio_option_square_label"
        },
        {
          "value": "portrait",
          "label": "t:sections.general_section_settings.img_ratio_option_portrait_label"
        },
        {
          "value": "portrait-xl",
          "label": "t:sections.general_section_settings.img_ratio_option_portrait_xl_label"
        },
        {
          "value": "landscape",
          "label": "t:sections.general_section_settings.img_ratio_option_landscape_label"
        }
      ],
      "default": "default",
      "label": "t:sections.general_section_settings.img_ratio_label"
    },
    {
      "type": "text",
      "id": "upsell_title",
      "label": "Upsell Title"
    },
    {
      "type": "checkbox",
      "id": "show_add_to_cart",
      "default": true,
      "label": "t:settings_schema.products.show_add_to_cart.label",
      "info": "t:settings_schema.products.show_add_to_cart.info"
    }
  ]
}
{% endschema %}
